<Sysmon schemaversion="4.90">
  <HashAlgorithms>md5,sha256</HashAlgorithms>
  <EventFiltering>

    <RuleGroup groupRelation="or">
      <ProcessCreate onmatch="include">
        
        <Rule groupRelation="and">
            <Image condition="contains any">\Users\;\ProgramData\;\Windows\Temp\</Image>
        </Rule>

        <Rule groupRelation="and">
            <Image condition="contains any">cmd.exe;powershell.exe;pwsh.exe;rundll32.exe;regsvr32.exe;certutil.exe;curl.exe;whoami.exe;net.exe;net1.exe;reg.exe;schtasks.exe;fodhelper.exe;bitsadmin.exe;ChromeSetup.exe</Image>
        </Rule>
        
        <Rule groupRelation="and">
            <ParentImage condition="end with">svchost.exe</ParentImage>
            <User condition="is">NT AUTHORITY\SYSTEM</User>
            <Image condition="excludes">C:\Windows\System32\*</Image> 
        </Rule>
        <Rule groupRelation="and">
            <ParentImage condition="end with">svchost.exe</ParentImage>
            <Image condition="end with">rundll32.exe</Image>
        </Rule>

      </ProcessCreate>
    </RuleGroup>

    <RuleGroup groupRelation="or">
      <ProcessTerminate onmatch="include">
        
        <Rule groupRelation="and">
            <Image condition="contains any">cmd.exe;powershell.exe;pwsh.exe;rundll32.exe;regsvr32.exe;certutil.exe;curl.exe;whoami.exe;net.exe;net1.exe;reg.exe;schtasks.exe;fodhelper.exe;bitsadmin.exe;ChromeSetup.exe</Image>
        </Rule>

        <Rule groupRelation="and">
            <Image condition="contains any">\Users\;\ProgramData\;\Windows\Temp\</Image>
        </Rule>

      </ProcessTerminate>
    </RuleGroup>

    <NetworkConnect onmatch="exclude">
        <Image condition="end with">chrome.exe</Image>
        <Image condition="end with">msedge.exe</Image>
        <Image condition="end with">firefox.exe</Image>
        <Image condition="is">C:\Windows\System32\svchost.exe</Image> 
    </NetworkConnect>


    <RuleGroup groupRelation="or">
      <FileCreate onmatch="include">
        <Rule groupRelation="and">
            <TargetFilename condition="contains any">\Users\;\ProgramData\;\Windows\Temp\</TargetFilename>
        </Rule>
      </FileCreate>
    </RuleGroup>

    <RuleGroup groupRelation="or">
      <RegistryEvent onmatch="include">
        <TargetObject condition="contains">\Software\Classes\</TargetObject>
        <TargetObject condition="contains">\CurrentVersion\Run</TargetObject>
      </RegistryEvent>
    </RuleGroup>

    <RuleGroup groupRelation="or">
      <FileCreateStreamHash onmatch="include">
        <TargetFilename condition="end with">:Zone.Identifier</TargetFilename>
      </FileCreateStreamHash>
    </RuleGroup>

  </EventFiltering>
</Sysmon>